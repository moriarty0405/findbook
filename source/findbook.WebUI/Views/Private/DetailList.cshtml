@model findbook.WebUI.Models.PrivateView

@{
    ViewBag.Title = "私信";

    ////从cookie中获取userID
    //HttpCookie cookie = Request.Cookies["user"];
    //string userID = cookie["userID"].ToString();

    //从Session中获取userID
    string userID = Session["logOnUserID"].ToString();

    var User = Model.Privates.FirstOrDefault();
    string rUserID = User.rUserID;
    string rUserName = User.rUserName;
    
    if (rUserID.Equals(userID)) {
        rUserID = User.sUserID;
        rUserName = User.sUserName;
    }

    //将接受用户的信息写入Session
    Session["rUserID"] = rUserID;
    Session["rUserName"] = rUserName;

}

<script src="../../Scripts/MicrosoftAjax.js" type="text/javascript"></script>  
<script src="../../Scripts/MicrosoftMvcAjax.js" type="text/javascript"></script>
<script src="../../Scripts/jquery.unobtrusive-ajax.js" type="text/javascript"></script>

@*<script type="text/javascript">
    //最新消息每5秒刷新一次
    setInterval(function () {
        $.ajax({
            url: '@Url.Action("DetailList", "Private")', //异步请求Action
            data: "id=@rUserID",
            type: "POST",
//            success: function (result) {
//                $("#partialContainer").html(result);
//            }
        });
    }, 5000);
 </script>*@

<div class="content">
	<!--私信-->
	<div class="sixin">
		<p>
            @*<a href="#" target="_blank">《返回私信首页</a>*@
            @Html.RouteLink("<<返回私信首页", new {
                                        Controller = "Private",
                                        Action = "List",
                                        userID = userID
                                    })
        </p>
		<p><span class="c05">发私信给</span><span class="c06">@rUserName</span>:</p>
		<div class="comment_box">
			@using (Ajax.BeginForm("SendPrivate", 
                        new { 
                            Controller = "Private", Action = "SendPrivate",
                            sUserID = userID, rUserID = Session["rUserID"]
                        }, 
                        new AjaxOptions { UpdateTargetId = "target" })) {
				<textarea rows="6" cols="93" name="pmBody"></textarea>
				<input type="submit" value="发送"></input>
			}
		</div>
	</div>
	<div class="comment_zone">
		<div class="comment_zone_inner" id="partialContainer">
			<!--评论-->
			<ul>
                @foreach (var m in Model.Privates) {
                    //发给我的私信
                    if (m.rUserID.Equals(userID)) {
                        Html.RenderPartial("ReceivedPrivateDetail", m);
                    } else {                      
                        //显示我发出的私信
                        Html.RenderPartial("SentPrivateDetail", m);
                    }
                    
                }
			</ul>
		</div>
	</div>
</div>
